<!DOCTYPE html>
<html>
<head>
    <title>Live Microphone Level</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h2>Live Microphone Level</h2>

<div style="width:100%; max-width:1000px; height:400px;">
    <canvas id="chart"></canvas>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const ctx = document.getElementById('chart').getContext('2d');

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Sound Level',
                data: [],
                borderWidth: 3,
                borderColor: 'red',
                backgroundColor: 'rgba(255,0,0,0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 0
            }]
        },
        options: {
            animation: false,
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false
                }
            }
        }
    });

    let lastId = null;

    async function load() {

        let url = "/microphone-data/";

        if (lastId !== null) {
            url += `?last_id=${lastId}`;
        }

        try {
            const res = await fetch(url);
            const data = await res.json();

            if (data.length > 0) {

                data.forEach(item => {
                    chart.data.labels.push(item.id);
                    chart.data.datasets[0].data.push(Number(item.level));
                });

                lastId = data[data.length - 1].id;

                // Keep only last 50 points
                while (chart.data.labels.length > 50) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                }

                chart.update();
            }

        } catch (error) {
            console.error("Fetch error:", error);
        }
    }

    // Load initial data
    load();

    // Update every second
    setInterval(load, 300);

});
</script>

</body>
</html>