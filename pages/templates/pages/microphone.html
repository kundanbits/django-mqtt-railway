<!DOCTYPE html>
<html>
<head>
    <title>Live Microphone Graph</title>
</head>
<body>

<h2>Live Microphone Level</h2>

<div style="width:100%; height:400px;">
    <canvas id="chart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const ctx = document.getElementById('chart');

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Sound Level',
                data: [],
                borderWidth: 2,
                borderColor: 'red',
                tension: 0.3
            }]
        },
        options: {
            animation: false,
            responsive: true,
            scales: {
                y: {
                    min: 0,
                    max: 10
                }
            }
        }
    });

    let lastId = 0;

    async function initialLoad() {
        const res = await fetch("/microphone-data/");
        const data = await res.json();

        data.forEach(item => {
            lastId = item.id;
            chart.data.labels.push(item.id);
            chart.data.datasets[0].data.push(item.level);
        });

        chart.update();
    }

    async function loadNewData() {
        const res = await fetch(`/microphone-data/?last_id=${lastId}`);
        const data = await res.json();

        data.forEach(item => {
            lastId = item.id;
            chart.data.labels.push(item.id);
            chart.data.datasets[0].data.push(item.level);

            if (chart.data.labels.length > 50) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
        });

        if (data.length > 0) {
            chart.update();
        }
    }

    initialLoad();
    setInterval(loadNewData, 500);

});
</script>

</body>
</html>